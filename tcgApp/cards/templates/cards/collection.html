{% extends 'base.html' %}

{% block title %}Collection Detail{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 mt-4">
    <form id="cardForm" action="{% url 'cards:submit' collection.id %}" method="post">
    {% csrf_token %}
    <fieldset>
        <legend><h2 id="collection-name">{{ collection.collection_name }}</h2></legend>
        {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

        <!-- Search Bar and Results Section -->
        <div id="search-section" class="mb-4">
            <h3>Search for a Card</h3>
            <input type="text" id="cardSearchInput" class="form-control" placeholder="Search for a card...">
            <button type="button" id="searchButton" class="btn btn-primary mt-2">Search</button>
        </div>

        <!-- Grid of Search Results -->
        <div id="search-results-grid" class="row">
            <!-- Dynamically populated cards will go here -->
        </div>

        <!-- Card Details Preview -->
        <div id="card-details" class="mt-4" style="display:none;">
            <h4>Card Details</h4>
            <div id="card-detail-content">
                <!-- This will be dynamically populated with card details -->
            </div>
            <button type="button" id="add-to-collection" class="btn btn-success">Add to Collection</button>
        </div>

        <!-- Add Selected Cards to Collection -->
        <button type="button" id="add-selected" class="btn btn-secondary mt-3">Add Selected Cards to Collection</button>

        <!-- Existing Cards List in Table Format (unchanged) -->
        <h3 class="mt-4">Existing Cards</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Card Name</th>
                    <th>Card Type</th>
                    <th>Color</th>
                    <th>Mana Cost</th>
                    <th>Set Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for card in collection.card_set.all %}
                <tr id="card_{{ card.id }}">
                    <td>{{ card.card_name }}</td>
                    <td>{{ card.card_type }}</td>
                    <td>{{ card.color }}</td>
                    <td>{{ card.mana_cost }}</td>
                    <td>{{ card.set_name }}</td>
                    <td>${{ card.price_usd|default:0 }}</td>
                    <td>
                        <div class="input-group">
                            <input type="number" name="quantity_{{ card.id }}" class="form-control" value="{{ card.quantity }}" min="0">
                        </div>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger" onclick="removeCardFromCollection({{ card.id }})">Remove</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </fieldset>
    </form>
</div>

<script>
    // Function to search for cards and display them
    document.getElementById('searchButton').addEventListener('click', function() {
        let searchQuery = document.getElementById('cardSearchInput').value;
        if (searchQuery) {
            fetchCards(searchQuery);
        }
    });

    // Fetch cards based on the search query from Scryfall API
    function fetchCards(query) {
        let url = `https://api.scryfall.com/cards/search?q=${query}&unique=cards`;
        fetch(url)
            .then(response => response.json())
            .then(data => displaySearchResults(data));
    }

    // Display the search results in the grid
    function displaySearchResults(data) {
        let gridContainer = document.getElementById('search-results-grid');
        gridContainer.innerHTML = ''; // Clear previous results

        data.data.forEach(card => {
            let cardElement = document.createElement('div');
            cardElement.classList.add('col-md-3', 'mb-3');
            cardElement.innerHTML = `
                <div class="card" onclick="showCardDetails('${card.id}')">
                    <img src="${card.image_uris.normal}" alt="${card.name}" class="card-img-top">
                    <div class="card-body">
                        <button type="button" class="btn btn-outline-primary select-card" data-id="${card.id}">Select</button>
                    </div>
                </div>
            `;
            gridContainer.appendChild(cardElement);
        });

        // Add event listeners to select buttons
        let selectButtons = document.querySelectorAll('.select-card');
        selectButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.classList.toggle('btn-success');
                this.classList.toggle('btn-outline-primary');
                this.textContent = this.classList.contains('btn-success') ? 'Selected' : 'Select';
            });
        });
    }

    // Show the detailed view of a selected card
    function showCardDetails(cardId) {
        let url = `https://api.scryfall.com/cards/${cardId}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                let detailsDiv = document.getElementById('card-detail-content');
                detailsDiv.innerHTML = `
                    <img src="${data.image_uris.normal}" alt="${data.name}" class="img-fluid">
                    <p><strong>Name:</strong> ${data.name}</p>
                    <p><strong>Type:</strong> ${data.type_line}</p>
                    <p><strong>Color:</strong> ${data.colors.join(', ')}</p>
                    <p><strong>Mana Cost:</strong> ${data.mana_cost || 'N/A'}</p>
                    <p><strong>Set:</strong> ${data.set_name}</p>
                    <p><strong>Price (USD):</strong> $${data.prices.usd || 'N/A'}</p>
                `;
                document.getElementById('card-details').style.display = 'block';
                document.getElementById('add-to-collection').onclick = function() {
                    addCardToCollection(data);
                };
            });
    }

    // Add a selected card to the collection
    function addCardToCollection(cardData) {
        // Example: Add the card to the form data, or send a request to your backend to add the card
        alert(`Adding ${cardData.name} to the collection`);
        // Actual form submission or API request can go here
    }

    // Add all selected cards to the collection
    document.getElementById('add-selected').addEventListener('click', function() {
        let selectedCards = [];
        let selectButtons = document.querySelectorAll('.select-card.btn-success');
        selectButtons.forEach(button => {
            selectedCards.push(button.getAttribute('data-id'));
        });
        if (selectedCards.length > 0) {
            // Example: Add selected cards to the collection (e.g., send data to backend)
            alert('Adding selected cards to the collection: ' + selectedCards.join(', '));
            // Submit the form with selected cards
        } else {
            alert('No cards selected.');
        }
    });
</script>
{% endblock %}
