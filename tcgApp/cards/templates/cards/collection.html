{% extends 'base.html' %}

{% block title %}Collection Detail{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 mt-4">
    <form id="cardForm" action="{% url 'cards:submit' collection.id %}" method="post">
    {% csrf_token %}
    <fieldset>
        <legend><h2 id="collection-name">{{ collection.collection_name }}</h2></legend>
        {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

        <!-- Search Bar and Results Section -->
        <div id="search-section" class="mb-4">
            <h3>Search for a Card</h3>
            <input type="text" id="cardSearchInput" class="form-control" placeholder="Search for a card...">
            <button type="button" id="searchButton" class="btn btn-primary mt-2">Search</button>
        </div>

        <!-- Grid of Search Results -->
        <div id="search-results-grid" class="row">
            <!-- Dynamically populated cards will go here -->
        </div>

        <!-- Selected Cards Section -->
        <div id="selected-cards-section" class="mt-4">
            <h3>Selected Cards</h3>
            <div id="selected-cards-grid" class="row">
                <!-- Dynamically populated selected cards will go here -->
            </div>
        </div>

        <!-- Add Selected Cards to Collection -->
        <button type="button" id="add-selected" class="btn btn-secondary mt-3">Add Selected Cards to Collection</button>

        <!-- Existing Cards List in Table Format (unchanged) -->
        <h3 class="mt-4">Existing Cards</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Card Name</th>
                    <th>Card Type</th>
                    <th>Color</th>
                    <th>Mana Cost</th>
                    <th>Set Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for card in collection.card_set.all %}
                <tr id="card_{{ card.id }}">
                    <td>{{ card.card_name }}</td>
                    <td>{{ card.card_type }}</td>
                    <td>{{ card.color }}</td>
                    <td>{{ card.mana_cost }}</td>
                    <td>{{ card.set_name }}</td>
                    <td>${{ card.price_usd|default:0 }}</td>
                    <td>
                        <div class="input-group">
                            <input type="number" name="quantity_{{ card.id }}" class="form-control" value="{{ card.quantity }}" min="0">
                        </div>
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger" onclick="removeCardFromCollection({{ card.id }})">Remove</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </fieldset>
    </form>
</div>

<script>
    // Function to search for cards and display them
    document.getElementById('searchButton').addEventListener('click', function() {
        let searchQuery = document.getElementById('cardSearchInput').value;
        if (searchQuery) {
            fetchCards(searchQuery);
        }
    });

    // Fetch cards based on the search query from Scryfall API
    function fetchCards(query) {
        let sanitizedQuery = encodeURIComponent(query);  // Sanitize the query for special characters
        let url = `https://api.scryfall.com/cards/search?q=${sanitizedQuery}&unique=cards`;
        fetch(url)
            .then(response => response.json())
            .then(data => displaySearchResults(data));
    }

    // Display the search results in the grid
    function displaySearchResults(data) {
        let gridContainer = document.getElementById('search-results-grid');
        gridContainer.innerHTML = ''; // Clear previous results

        data.data.forEach(card => {
            let cardName = card.name;
            let cardImageUrl = card.image_uris ? card.image_uris.png : null;  // Use PNG with transparent background
            let isSplitCard = card.card_faces && card.card_faces.length > 1;

            // If no image is found, we use the card's name as a fallback
            if (!cardImageUrl) {
                cardImageUrl = `https://via.placeholder.com/150?text=${cardName}`;
            }

            let cardElement = document.createElement('div');
            cardElement.classList.add('col-md-3', 'mb-3');
            cardElement.setAttribute('id', `card-${card.id}`); // Add ID for styling
            cardElement.innerHTML = `
                <div class="card card-item" data-id="${card.id}" id="card-${card.id}">
                    <h5 class="card-title">${cardName}</h5>
                    <img src="${cardImageUrl}" alt="${cardName}" class="card-img-top" id="card-image-${card.id}">
                    <div class="card-body">
                        <button type="button" class="btn btn-outline-primary select-card" data-id="${card.id}" id="select-button-${card.id}">Select</button>
                        ${isSplitCard ? `<button type="button" class="btn btn-info flip-card mt-2" onclick="flipCard('${card.id}')">Flip</button>` : ''}
                    </div>
                </div>
            `;
            gridContainer.appendChild(cardElement);
        });

        // Add event listener to handle card selection dynamically
        document.querySelectorAll('.select-card').forEach(button => {
            button.addEventListener('click', function() {
                let cardId = this.getAttribute('data-id');
                let cardName = this.closest('.card').querySelector('.card-title').textContent;
                let cardImageUrl = this.closest('.card').querySelector('img').src;

                this.classList.toggle('btn-success');
                this.classList.toggle('btn-outline-primary');
                this.textContent = this.classList.contains('btn-success') ? 'Selected' : 'Select';

                handleCardSelection(this, cardId, cardName, cardImageUrl);
            });
        });
    }

    // Handle card selection for selected cards grid
    let selectedCards = [];

    function handleCardSelection(button, cardId, cardName, cardImageUrl) {
        if (button.classList.contains('btn-success')) {
            selectedCards.push({ id: cardId, name: cardName, image: cardImageUrl });
        } else {
            selectedCards = selectedCards.filter(card => card.id !== cardId);
        }
        updateSelectedCardsGrid();
    }

    // Update the "Selected Cards" grid
    function updateSelectedCardsGrid() {
        let selectedGrid = document.getElementById('selected-cards-grid');
        selectedGrid.innerHTML = ''; // Clear previous selected cards

        selectedCards.forEach(card => {
            let cardElement = document.createElement('div');
            cardElement.classList.add('col-md-3', 'mb-3');
            cardElement.innerHTML = `
                <div class="card selected-card" id="selected-card-${card.id}">
                    <img src="${card.image}" alt="Selected Card" class="card-img-top" onmouseover="this.style.transform='scale(1.5)'" onmouseout="this.style.transform='scale(1)'">
                </div>
            `;
            selectedGrid.appendChild(cardElement);
        });
    }

    // Add all selected cards to the collection
    document.getElementById('add-selected').addEventListener('click', function() {
        if (selectedCards.length > 0) {
            let cardNames = selectedCards.map(card => card.name);
            let cardCount = cardNames.length;
            let displayedNames = cardNames.slice(0, 10); // Show up to 10 names
            let extraCount = cardCount > 10 ? `+${cardCount - 10} more cards` : '';
    
            let modalMessage = `Adding selected cards to the collection: ${displayedNames.join(', ')}`;
            if (extraCount) {
                modalMessage += ` (${extraCount})`;
            }
    
            alert(modalMessage);
        } else {
            alert('No cards selected.');
        }
    });
</script>

{% endblock %}
